<!DOCTYPE html>
<html>
<head>
  <title>QR Code Reader</title>
</head>
<body>
    <p id="OS">QR Code Reader</p>
    <canvas id="canvas" width="800px" height="600px" willReadFrequently="true"></canvas>

    <!-- create a textbox for the QR code values -->
    <p id="text">QR Code Reader</p>

    <script src="jsQR/jsQR.js"></script>

<!--   <video id="video" autoplay controls muted playsinline></video> -->

    <br><br>

    <script>        
        function getOS() {
            let userAgent = navigator.userAgent || navigator.vendor || window.opera;

            // Windows OS
            if (/Win/i.test(navigator.platform)) {
                return 'Windows';
            }
            // macOS
            else if (/Mac/i.test(navigator.platform)) {
                return 'MacOS';
            }
            // iOS
            else if (/iPhone/i.test(userAgent)) {
                return 'iOS';
            }
            // Android
            else if (/Android/i.test(userAgent)) {
                return 'Android';
            }
            // Linux
            else if (/Linux/i.test(navigator.platform)) {
                return 'Linux';
            }
            else {
                return 'other';
            }
        }

        os = document.getElementById("OS");
        os.textContent = getOS();

        // draw a circle to the middle of the canvas with radius 66% of the height of the canvas
        var canvas = document.getElementById('canvas');
        canvas.willReadFrequently = true;

        // the video didn't show on the canvas
        if (!canvas.getContext) {
            alert('Your browser does not support the HTML5 canvas element.');
        } else {
            var ctx = canvas.getContext('2d');
            ctx.beginPath();
            ctx.arc(canvas.width / 2, canvas.height / 2, canvas.height / 3, 0, 2 * Math.PI);
            ctx.fillStyle = 'darkorange';
            ctx.fill(); 
        }

        var constraints;

        if ("Android" === getOS()) {
            constraints = { video: { facingMode: { exact: "environment" } } };
//            constraints = { video: true };
        } else {
            constraints = { video: true }
        }

        var video = document.createElement('video');

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            // Safe to call getUserMedia
            navigator.mediaDevices.getUserMedia( constraints )
                .then(stream => {
                    video.srcObject = stream;
                    video.play();
                })
                .catch(err => {
                    console.error('Error accessing the camera:', err);
                });
        } else {
            console.error('Webcam is not available');
        }
        
        document.getElementById("text").innerHTML = "Facing mode: " + constraints;

        // show the camera preview in the canvas
        video.addEventListener('play', () => {
            drawVideo();
        });
        
        function drawVideo() {
            if (video.paused || video.ended) {
                console.log('video is paused or ended');
                return;
            }
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            // write console "image is updated"
            console.log('image is updated');

            // get image data from canvas
            var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            // decode the QR code from the image data
            var code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) {
                console.log('QR Code detected: ' + code.data);
                
                // add the new QR value to the textbox, every code in new line, filter duplicates
                var text = document.getElementById('text');
                if (!text.textContent.includes(code.data)) {
                    text.textContent += code.data + '\n';
                    // make beep sound
                    var audio = new Audio('beep.mp3');
                    audio.play();
                }
            }

            requestAnimationFrame(drawVideo);
        }





        </script>




    <button onclick="copyTextToClipboard()">Copy text to clipboard</button>
    <script>
        function copyTextToClipboard() {
            var text = document.getElementById('text').textContent;
            navigator.clipboard.writeText(text);
        }   
    </script>

    <button onclick="clearText()">Clear text</button>
    <script>
        function clearText() {
            var text = document.getElementById('text');
            text.textContent = '';  
        }   
    </script>


    <!-- i need a button to toggle on off camera -->
    <button onclick="toggleCamera()">Toggle camera</button>

    <script>
        function toggleCamera() {
            if (video.srcObject) {
                video.srcObject = null;
            } else {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(stream => {
                        video.srcObject = stream;
                        video.play();
                    })
                    .catch(err => {
                        console.error('Error accessing the camera:', err);
                    });
            }
        }
    </script>

    <button onclick="switchCamera()">Switch Camera</button>
    <script>
        function switchCamera() {
/*
            // if more cameras avalilable, then switch through between them, every click turns on a new camera
            if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                console.log("Multiple Cameras Available");
                navigator.mediaDevices.enumerateDevices()
                    .then(devices => {
                        const videoDevices = devices.filter(device => device.kind === 'videoinput');
                        if (videoDevices.length > 1) {
                            const currentDeviceId = video.srcObject.getVideoTracks()[0].getSettings().deviceId;
                            const newDeviceId = videoDevices.find(device => device.deviceId !== currentDeviceId).deviceId;
                            video.srcObject = null;
                            navigator.mediaDevices.getUserMedia({ video: { deviceId: newDeviceId } })
                                .then(stream => {
                                    video.srcObject = stream;
                                    video.play();
                                })
                                .catch(err => {
                                    console.error('Error accessing the camera:', err);
                                });
                        }
                    })
                    .catch(err => {
                        console.error('Error enumerating video devices:', err);
                    });
            }   
            */

            function switchCamera() {
                // if more cameras available, then switch between them, every click turns on a new camera
                if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                    console.log("Multiple Cameras Available");
                    navigator.mediaDevices.enumerateDevices()
                        .then(devices => {
                            const videoDevices = devices.filter(device => device.kind === 'videoinput');
                            if (videoDevices.length > 1) {
                                const currentDeviceId = video.srcObject.getVideoTracks()[0].getSettings().deviceId;
                                const newDevice = videoDevices.find(device => device.deviceId !== currentDeviceId);
                                const facingMode = newDevice.label.includes('front') ? 'user' : 'environment';
                                video.srcObject = null;
                                navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } })
                                    .then(stream => {
                                        video.srcObject = stream;
                                        video.play();
                                    })
                                    .catch(err => {
                                        console.error('Error accessing the camera:', err);
                                    });
                            }
                        })
                        .catch(err => {
                            console.error('Error enumerating video devices:', err);
                        });
                }   
            }
            








            /*if (video.srcObject) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => {
                        video.srcObject = stream;
                        video.play();
                    })
                    .catch(err => {
                        console.error('Error accessing the camera:', err);
                    });
            }
            */
            /*
            // if more cameras are available, then create a button to loop through between them
            if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                navigator.mediaDevices.enumerateDevices()
                    .then(devices => {
                        const videoDevices = devices.filter(device => device.kind === 'videoinput');
                        if (videoDevices.length > 1) {
                            const button = document.createElement('button');
                            button.textContent = 'Switch camera';
                            document.body.appendChild(button);
                            button.addEventListener('click', () => {
                                const currentDeviceId = video.srcObject.getVideoTracks()[0].getSettings().deviceId;
                                const newDeviceId = videoDevices.find(device => device.deviceId !== currentDeviceId).deviceId;
                                video.srcObject = null;
                                navigator.mediaDevices.getUserMedia({ video: { deviceId: newDeviceId } })
                                    .then(stream => {
                                        video.srcObject = stream;
                                        video.play();
                                    })
                                    .catch(err => {
                                        console.error('Error accessing the camera:', err);
                                    });
                            });
                        }
                    })
                    .catch(err => {
                        console.error('Error accessing the camera:', err);
                    });
            }
            */

        }
    </script>

    <button onclick="turnOffCamera()">Turn off camera</button> 
    <script>
        function turnOffCamera() {
            video.srcObject = null;
            // turn off webcam too
            navigator.mediaDevices.getUserMedia({ video: false })
                .then(stream => {
                    video.srcObject = stream;
                    video.play();
                })
                .catch(err => {
                    console.error('Error accessing the camera:', err);
                });
        }   
    </script>



</body>
</html>
