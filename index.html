<!DOCTYPE html>
<html>

<head>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

    <style>
        #innerbox
        {
            width:1500px;
            height:800px; /* or whatever width you want. */
            display: inline-block;
        }
    </style>
</head>

<body>
    <h1>ByG's COVID-19 Visualisation</h1>
    <p>Based on the datasets of CSSEGISandData released on  
        <a href="https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series">
        GitHub</a>.
    </p>

    <label for="CountrySelector">Choose a country:</label>
    <select name="CountrySelector" id="CountrySelector" onchange="selectorChanged()">
        <option value="Hungary">Hungary</option>
        <option value="Austria">Austria</option>
        <option value="Slovakia">Slovakia</option>
        <option value="Ukraine">Ukraine</option>
        <option value="Romania">Romania</option>
        <option value="Serbia">Serbia</option>
        <option value="Croatia">Croatia</option>
        <option value="Slovenia">Slovenia</option>
        <option value="Germany">Germany</option>
        <option value="Italy">Italy</option>
        <option value="Spain">Spain</option>
        <option value="France">France</option>
    </select>

    <label for="ChartSelector">Choose a chart:</label>
    <select name="ChartSelector" id="ChartSelector" onchange="selectorChanged()">
        <option value="Confirmed">Confirmed</option>
        <option value="Recovered">Recovered</option>
        <option value="Deaths">Deaths</option>
        <option value="NewCases">New Cases</option>
        <option value="NewCases1M">New Cases / 1 Million</option>
        <option value="ActiveCases">Active Cases</option>
        <option value="ActiveCases1M">Active Cases / 1 Million</option>
    </select>

    <label for="ChartTypeSelector" id="ChartTypeSelectorLabel">Y Axis type:</label>
    <select name="ChartTypeSelector" id="ChartTypeSelector" onchange="selectorChanged()">
        <option value="Automatic">Automatic (for the details)</option>
        <option value="Fixed">Fixed (for the comparison)</option>
    </select>

    <label for="ChartRangeSelector" id="ChartRangeSelectorLabel">Choose maximum of Y Axis:</label>
    <select name="ChartRangeSelector" id="ChartRangeSelector" onchange="selectorChanged()">
        <option value="100">100</option>
        <option value="200">200</option>
        <option value="300">300</option>
        <option value="500">500</option>
        <option value="800">800</option>
        <option value="1300">1300</option>
        <option value="2100">2100</option>
        <option value="3400">3400</option>
        <option value="5500">5500</option>
        <option value="8900">8900</option>
    </select>

    <p><span id="startdate"></span> - <span id="enddate"></span></p>

    <div id="innerbox"><canvas id="myChartID" width="1024" height="468"></canvas></div>

    <script>
        let country = "";
        let charttype = "";
        let rawconfirmed = "";
        let rawrecovered = "";
        let rawdeaths = "";
        let rawpopulation = "";
        let allconfirmed = [];
        let allrecovered = [];
        let alldeaths = [];
        let allpopulation = [];

        let confirmedID = "";
        let recoveredID = "";
        let deathsID = "";
        let populationID = "";

        let ctx = document.getElementById('myChartID').getContext('2d'); // Chart Data Set

        let myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: "Dummy Chart",
                    data: [],
                    backgroundColor: 'rgba(255, 0, 0, 1)'
                }]
            },
//*
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
//*/
        });

        $(document).ready(async function () 
        {
            await loadData("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv");
            await loadData("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv");
            await loadData("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv");
            await loadData("population.csv");

            await convertStringToArray(rawconfirmed, allconfirmed);
            await convertStringToArray(rawrecovered, allrecovered);
            await convertStringToArray(rawdeaths, alldeaths);
            await convertStringToArray(rawpopulation, allpopulation);

            selectorChanged();
            
            document.getElementById("startdate").innerHTML = convertDate(allconfirmed[0][4]);
            document.getElementById("enddate").innerHTML = convertDate(allconfirmed[0][allconfirmed[0].length-1]);
        });

        function convertDate(date)
        {
            let data = date.split('/');
            let retval = "20" + data[2] + "." + data[0] + "." + data[1];
            return retval;
        }

        async function loadData(v_url) 
        {
            try {
                var v_array = await getText(v_url);
                if (0 <= v_url.search("confirmed"))  { rawconfirmed  = v_array; }
                if (0 <= v_url.search("recovered"))  { rawrecovered  = v_array; }
                if (0 <= v_url.search("deaths"))     { rawdeaths     = v_array; }
                if (0 <= v_url.search("population")) { rawpopulation = v_array; }
            }
            catch{
                console.log(error);
            }
        }

        function getText(v_url) 
        {
            var data = jQuery.get(v_url, function(data) 
            {
                return data;
            });
            return data;
        }

        function convertStringToArray(string, array)
        {
            let lines = string.split(/\r\n|\n/);
            for (let i = 0; i < lines.length; i++ )
            {
                let data = lines[i].split(',');
                array.push(data);
            }
        }

        function getSelectValue(selectname)
        {
            var e = document.getElementById(selectname);
            var strUser = e.options[e.selectedIndex].value;
            return strUser;
        }

        function selectorChanged()
        {
            country    = getSelectValue("CountrySelector");
            chart      = getSelectValue("ChartSelector");
            charttype  = getSelectValue("ChartTypeSelector");
            chartrange = getSelectValue("ChartRangeSelector");

            if (charttype == "Fixed")
            {
                document.getElementById("ChartRangeSelector").hidden = false;
                document.getElementById("ChartRangeSelectorLabel").hidden = false;
                document.getElementById("ChartTypeSelectorLabel").hidden = true;
                document.getElementById("ChartTypeSelector").hidden = true;
                myChart.options.scales.yAxes[0].ticks.max = parseInt(chartrange);
            } else {
                document.getElementById("ChartRangeSelector").hidden = true;
                document.getElementById("ChartRangeSelectorLabel").hidden = true;
            }

            lookForIDs(country);
            prepareDataForChart(country);

            switch(chart)
            {
                case "Confirmed":
                    myChart.data.datasets[0].data = dataallcases; 
                    myChart.data.datasets[0].label = "Confirmed Cases in " + country;
                    break;
                case "Recovered":
                    myChart.data.datasets[0].data = dataallrecovered;  
                    myChart.data.datasets[0].label = "Recovered Cases in " + country;
                    break;
                case "Deaths":
                    myChart.data.datasets[0].data = dataalldeaths;  
                    myChart.data.datasets[0].label = "Deaths in " + country;
                    break;
                case "NewCases":
                    myChart.data.datasets[0].data = datanewcases;  
                    myChart.data.datasets[0].label = "New Cases in " + country;
                    break;
                case "NewCases1M":
                    myChart.data.datasets[0].data = datanewcases1M;  
                    myChart.data.datasets[0].label = "New Cases / 1 Million in " + country;
                    break;
                case "ActiveCases":
                    myChart.data.datasets[0].data = dataactive;  
                    myChart.data.datasets[0].label = "Active Cases in " + country;
                    break;
                case "ActiveCases1M":
                    myChart.data.datasets[0].data = dataactive1M;  
                    myChart.data.datasets[0].label = "Active Cases / 1 Million in " + country;
                    break;
                default:
                    myChart.data.datasets[0].data = datanewcases;  
                    myChart.data.datasets[0].label = "Should never occure...";
                    break;
            }

            myChart.data.labels = dateaxis;
            myChart.update();
        }
        
        function lookForIDs(country) 
        {
            for (let i = 0; i < allconfirmed.length; i++)  if (allconfirmed[i][1]  == country) confirmedID = i;
            for (let i = 0; i < allrecovered.length; i++)  if (allrecovered[i][1]  == country) recoveredID = i;
            for (let i = 0; i < alldeaths.length; i++)     if (alldeaths[i][1]     == country) deathsID = i;
            for (let i = 0; i < allpopulation.length; i++) if (allpopulation[i][0] == country) populationID = i;
        }

        let dateaxis = [];
        let dataallcases = [];
        let dataallrecovered = [];
        let dataalldeaths = [];
        let datanewcases = [];
        let datanewcases1M = [];
        let dataactive = [];
        let dataactive1M = [];

        function prepareDataForChart(country)
        {
            dateaxis = [];
            dataallcases = [];
            dataallrecovered = [];
            dataalldeaths = [];
            datanewcases = [];
            datanewcases1M = [];
            dataactive = [];
            dataactive1M = [];
            for( let i = 4; i < allconfirmed[0].length; i++)
            {
                dateaxis.push(convertDate(allconfirmed[0][i]));
                dataallcases.push(allconfirmed[confirmedID][i]);
                dataallrecovered.push(allrecovered[recoveredID][i]);
                dataalldeaths.push(alldeaths[deathsID][i]);
                dataactive.push(allconfirmed[confirmedID][i]-allrecovered[recoveredID][i]-alldeaths[deathsID][i]);
                dataactive1M.push(dataactive[i-4]/(allpopulation[populationID][1]/1000000));
                if ( i == 4 ) 
                {
                    datanewcases.push(0);
                    datanewcases1M.push(0);
                } else {
                    datanewcases.push(allconfirmed[confirmedID][i]-allconfirmed[confirmedID][i-1]);
                    datanewcases1M.push((allconfirmed[confirmedID][i]-allconfirmed[confirmedID][i-1])/(allpopulation[populationID][1]/1000000));
                }
            }
        }
    </script>
</body>
</html>